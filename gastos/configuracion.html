<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Configuraci√≥n - Sistema de Gastos Symbiot</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#191C24">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

    <!-- CSS MODULAR -->
    <link rel="stylesheet" href="css/dashboard-main.css?v=3.2.1">
    <link rel="stylesheet" href="css/dashboard-widgets.css?v=3.2.1">
    <link rel="stylesheet" href="css/dashboard-responsive.css?v=3.2.1">
    <link rel="stylesheet" href="css/theme-toggle.css?v=1.0.0">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html"><img src="assets/images/Symbiot_logo_dark_horizon.png" alt="SYMBIOT Logo" style="height: 30px; margin-right: 8px;"></a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item" id="navLinkDashboard">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item" id="navLinkGastos">
                        <a class="nav-link" href="gastos.html">
                            <i class="fas fa-money-bill-wave me-1"></i>Gastos
                        </a>
                    </li>
                    <li class="nav-item" id="navLinkIngresos">
                        <a class="nav-link" href="ingresos.html">
                            <i class="fas fa-coins me-1"></i>Ingresos
                        </a>
                    </li>
                    <li class="nav-item" id="navLinkReportes">
                        <a class="nav-link" href="reportes.html">
                            <i class="fas fa-chart-bar me-1"></i>Reportes
                        </a>
                    </li>
                </ul>

                <ul class="navbar-nav">
                    <!-- Theme Toggle Button -->
                    <li class="nav-item d-flex align-items-center">
                        <button type="button" id="themeToggleBtn" class="theme-toggle-btn" title="Cambiar tema" aria-label="Cambiar tema">
                            <i class="fas fa-sun"></i>
                        </button>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="userName">Usuario</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="showUserProfile()">
                                <i class="fas fa-user me-2"></i>Mi Perfil
                            </a></li>
                            <li><a class="dropdown-item active" href="configuracion.html">
                                <i class="fas fa-cog me-2"></i>Configuraci√≥n
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="main-content">
            <!-- Header -->
            <div class="welcome-banner" id="welcomeBanner">
                <h4 class="mb-1"><i class="fas fa-cog me-2"></i>Configuraci√≥n de Cuenta</h4>
                <p class="mb-0">Actualiza tu informaci√≥n personal y preferencias</p>
            </div>

            <!-- Profile Form Card -->
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="text-white mb-0">
                                <i class="fas fa-user-edit me-2"></i>Informaci√≥n Personal
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Loading State -->
                            <div class="text-center py-4" id="profileLoading">
                                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                                <p class="mt-2">Cargando informaci√≥n del perfil...</p>
                            </div>

                            <!-- Profile Form -->
                            <form id="profileForm" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="profileNombre" class="form-label">
                                            <i class="fas fa-user me-1"></i>Nombre(s) <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="profileNombre"
                                               placeholder="Tu nombre" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="profileApellidos" class="form-label">
                                            <i class="fas fa-user me-1"></i>Apellidos
                                        </label>
                                        <input type="text" class="form-control" id="profileApellidos"
                                               placeholder="Tus apellidos">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="profileEmail" class="form-label">
                                            <i class="fas fa-envelope me-1"></i>Correo Electr√≥nico <span class="text-danger">*</span>
                                        </label>
                                        <input type="email" class="form-control" id="profileEmail"
                                               placeholder="tu@email.com" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="profileCelular" class="form-label">
                                            <i class="fas fa-mobile-alt me-1"></i>N√∫mero Celular
                                        </label>
                                        <input type="tel" class="form-control" id="profileCelular"
                                               placeholder="10 d√≠gitos" maxlength="15">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="profilePuesto" class="form-label">
                                            <i class="fas fa-briefcase me-1"></i>Puesto
                                        </label>
                                        <input type="text" class="form-control" id="profilePuesto"
                                               placeholder="Tu puesto en la empresa">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="profileRol" class="form-label">
                                            <i class="fas fa-user-shield me-1"></i>Rol en el Sistema
                                        </label>
                                        <input type="text" class="form-control" id="profileRol"
                                               readonly disabled style="background-color: rgba(255,255,255,0.05);">
                                        <small class="text-muted">El rol solo puede ser modificado por un administrador</small>
                                    </div>
                                </div>

                                <hr class="my-4" style="border-color: rgba(255,255,255,0.1);">

                                <!-- Password Section -->
                                <h6 class="text-white mb-3">
                                    <i class="fas fa-lock me-2"></i>Cambiar Contrase√±a
                                    <small class="text-muted">(opcional)</small>
                                </h6>

                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="profileCurrentPassword" class="form-label">
                                            Contrase√±a Actual
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="profileCurrentPassword"
                                                   placeholder="Contrase√±a actual">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('profileCurrentPassword')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="profileNewPassword" class="form-label">
                                            Nueva Contrase√±a
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="profileNewPassword"
                                                   placeholder="M√≠nimo 6 caracteres">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('profileNewPassword')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="profileConfirmPassword" class="form-label">
                                            Confirmar Contrase√±a
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="profileConfirmPassword"
                                                   placeholder="Repetir contrase√±a">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('profileConfirmPassword')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <small>
                                        <i class="fas fa-info-circle me-1"></i>
                                        Deja los campos de contrase√±a vac√≠os si no deseas cambiarla.
                                    </small>
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-flex justify-content-between mt-4">
                                    <a href="dashboard.html" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left me-1"></i>Volver al Dashboard
                                    </a>
                                    <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                                        <i class="fas fa-save me-1"></i>Guardar Cambios
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Theme Toggle - Cargar temprano para evitar flash -->
    <script src="js/theme-toggle.js?v=1.0.0"></script>

    <!-- API Client -->
    <script src="assets/js/api-client.js?v=3.1.3"></script>

    <!-- Dashboard Core (para funciones de utilidad) -->
    <script src="js/dashboard-core.js?v=3.4.0"></script>
    <script src="js/dashboard-auth.js?v=3.1.3"></script>

    <!-- Configuraci√≥n Script -->
    <script>
        // Variables globales
        let currentUserProfile = null;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîß Iniciando p√°gina de configuraci√≥n...');

            // Verificar autenticaci√≥n
            const isAuth = await checkAuthentication();
            if (!isAuth) {
                window.location.href = 'login.html';
                return;
            }

            // Cargar perfil del usuario
            await loadUserProfile();

            // Configurar formulario
            document.getElementById('profileForm').addEventListener('submit', handleProfileSubmit);
        });

        // Cargar informaci√≥n del perfil
        async function loadUserProfile() {
            try {
                console.log('üì• Cargando perfil del usuario...');

                const data = await window.apiGet('user/profile');

                if (data.success && data.user) {
                    currentUserProfile = data.user;
                    populateForm(data.user);

                    // Actualizar nombre en navbar
                    const userNameElement = document.getElementById('userName');
                    if (userNameElement) {
                        userNameElement.textContent = data.user.nombre;
                    }

                    // Mostrar formulario
                    document.getElementById('profileLoading').style.display = 'none';
                    document.getElementById('profileForm').style.display = 'block';

                    console.log('‚úÖ Perfil cargado correctamente');
                } else {
                    throw new Error(data.error || 'Error al cargar perfil');
                }

            } catch (error) {
                console.error('‚ùå Error cargando perfil:', error);
                showAlert('danger', 'Error al cargar el perfil: ' + error.message);
            }
        }

        // Poblar formulario con datos
        function populateForm(user) {
            document.getElementById('profileNombre').value = user.nombre || '';
            document.getElementById('profileApellidos').value = user.apellidos || '';
            document.getElementById('profileEmail').value = user.email || '';
            document.getElementById('profileCelular').value = user.celular || '';
            document.getElementById('profilePuesto').value = user.puesto || '';
            document.getElementById('profileRol').value = user.rol ? user.rol.charAt(0).toUpperCase() + user.rol.slice(1) : '';
        }

        // Manejar env√≠o del formulario
        async function handleProfileSubmit(event) {
            event.preventDefault();

            const saveBtn = document.getElementById('saveProfileBtn');
            const originalText = saveBtn.innerHTML;

            try {
                // Validaciones
                const nombre = document.getElementById('profileNombre').value.trim();
                const email = document.getElementById('profileEmail').value.trim();
                const newPassword = document.getElementById('profileNewPassword').value;
                const confirmPassword = document.getElementById('profileConfirmPassword').value;
                const currentPassword = document.getElementById('profileCurrentPassword').value;

                if (!nombre) {
                    showAlert('warning', 'El nombre es requerido');
                    return;
                }

                if (!email) {
                    showAlert('warning', 'El correo electr√≥nico es requerido');
                    return;
                }

                // Validar contrase√±as si se quiere cambiar
                if (newPassword || confirmPassword) {
                    if (newPassword !== confirmPassword) {
                        showAlert('warning', 'Las contrase√±as no coinciden');
                        return;
                    }
                    if (newPassword.length < 6) {
                        showAlert('warning', 'La contrase√±a debe tener al menos 6 caracteres');
                        return;
                    }
                    if (!currentPassword) {
                        showAlert('warning', 'Debes ingresar tu contrase√±a actual para cambiarla');
                        return;
                    }
                }

                // Mostrar loading
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';
                saveBtn.disabled = true;

                // Preparar datos
                const profileData = {
                    nombre: nombre,
                    apellidos: document.getElementById('profileApellidos').value.trim(),
                    email: email,
                    celular: document.getElementById('profileCelular').value.trim(),
                    puesto: document.getElementById('profilePuesto').value.trim()
                };

                // Agregar contrase√±a si se quiere cambiar
                if (newPassword) {
                    profileData.password = newPassword;
                    profileData.current_password = currentPassword;
                }

                console.log('üì§ Actualizando perfil...');

                const response = await window.apiPut('user/profile', profileData);

                if (response.success) {
                    showAlert('success', 'Perfil actualizado correctamente');

                    // Limpiar campos de contrase√±a
                    document.getElementById('profileCurrentPassword').value = '';
                    document.getElementById('profileNewPassword').value = '';
                    document.getElementById('profileConfirmPassword').value = '';

                    // Actualizar nombre en navbar si cambi√≥
                    if (response.user) {
                        const userNameElement = document.getElementById('userName');
                        if (userNameElement) {
                            userNameElement.textContent = response.user.nombre;
                        }
                    }

                    console.log('‚úÖ Perfil actualizado correctamente');
                } else {
                    throw new Error(response.error || 'Error al actualizar perfil');
                }

            } catch (error) {
                console.error('‚ùå Error actualizando perfil:', error);
                showAlert('danger', error.message || 'Error al actualizar el perfil');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        // Toggle para mostrar/ocultar contrase√±a
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
    </script>
</body>
</html>
